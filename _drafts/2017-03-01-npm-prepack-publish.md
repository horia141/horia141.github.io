---
published: false
---
The other day I published a small package to [GitHub](https://github.com/horia141/npm-prepack-publish) and [NPM][https://www.npmjs.com/package/npm-prepack-publish]. This post serves as documentation and tutorial.

I wanted to have better control over what files are included into an NPM package. The classical approach to building a package is to call [`npm pack`](https://docs.npmjs.com/cli/pack). This includes files from the current directory, and is controlled by the [`files`](https://docs.npmjs.com/files/package.json#files) field in `package.json`. My main goal was to make imports be super easy. But many times the structure of the current directory and the simplicity of `npm pack` caused issues.

For example, a common directory structure I use is:

```
- package.json
- README.md
- src
  - index.ts
  - dependency.ts
- fonts # some data files
  - font.woff
- out # generated by the build process
  - index.d.ts
  - index.js
  - dependency.d.ts
  - dependency.js
```

There's four types of files here. Source files in `src` are in source control. Being TypeScript they aren't particularly interesting for other users of the package though, so they shouldn't be put inside it. Config files like `package.json` are included in the package because they're required by NPM. Extra data files, such as the ones in the `fonts` directory are included. Furthermore, it makes sense for the whole directory to be included. Finally, output source files, in `out` should be included in the root of the archive. This makes it easy to use the package like so:

```
import { foo } from 'my-package'
import { bar } from 'my-package/dependency'
```

The structure inside the archive we'd like to have is:

```
- package.json
- README.md
- index.d.ts
- index.js
- dependency.d.ts
- dependency.js
- fonts
  - font.woff
```

Unfortunately, `npm pack` flattens any directory specified in the `files` property. So it can produce just something like:


```
- package.json
- README.md
- index.d.ts
- index.js
- dependency.d.ts
- dependency.js
- font.woff
```

This _is_ workable in the small scale. But after a while one is bound to end up in trouble. File collisions might happen, there's a difference between the structure on disk and the way the code accesses the files etc.

Furthermore, in a situation like the following:

```
- src
  - client
    - client.js
  - server
    - server.js
  - misc
    - misc.js
```

It's hard to obtain something like:
```
- client
  - client.js
- server
  - server.js
```

You have to specify either `src` in `files`, and end up with `misc`, or `src/client` and `src/server` and end up with a flattened hierarchy which leads to the same issues as above.