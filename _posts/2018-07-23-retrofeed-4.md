---
layout: post
title: "RetroFeed Work Log #4 - Sessions, Auth, Logging, etc"
date: 2018-07-23 08:20:05
categories: post
tags: raynor rpc retrofeed work-log
comments: true
published: false
---

So far we've setup a NPM package and setup NestJs for normal web programming. In this instalment of the [RetroFeed](https://horia141.com/retrofeed.html) we'll continue with the _standard_ web application setup and speak about the common middleware used.

The current file structure is more or less:

{% highlight bash %}
.
├── Dockerfile
├── config
│   ├── env.local
│   └── env.test
├── knexfile.js
├── migrations #hidden
├── package.json
├── scripts # hidden
├── secrets.tar.enc
├── src
│   ├── auth
│   │   └── auth.ts
│   ├── controllers
│   │   ├── app
│   │   │   ├── admin.hbs
│   │   │   ├── app.ts
│   │   │   ├── home.hbs
│   │   │   └── layout.hbs
│   │   └── tech
│   │       └── status.ts
│   ├── index.ts
│   ├── infra
│   │   ├── common.ts
│   │   ├── config.ts
│   │   ├── db-conn.ts
│   │   ├── request-id-middleware.ts
│   │   ├── request-time-middleware.ts
│   │   ├── request-version-middleware.ts
│   │   └── session-middleware.ts
│   └── services
│       └── user
│           ├── entities.ts
│           ├── events.ts
│           └── service.ts
├── test # hidden
└── test-e2e #hidden
{% endhighlight %}

The studied version is [v0.0.4](https://github.com/horia141/retrofeed/tree/v0.0.4). It has the whole set of auth related changes as well. But I'll cover those in the next post. With regards to the tree above, I've hidden a bunch of files and directories which aren't relevant to the discussion at hand. In any case, you can see that the `src` tree has become much beefier.

Express and NestJs come prepacked with a lot of goodies. However, since you can build both microservices and regular webapps with them, many things are left _optional_. So the first thing we must do is set up a bunch of must haves for regular web app development atop the scaffolding we have from the previous post. Luckily, the common form they'll take is that of a middleware applied to either all of the routes or _almost all_ of them, or some global switch telling NestJs to do something.

Right off the bat, in `src/index.ts`, there's a bunch of extra configuration in the `boostrap` function.

{% highlight typescript %}
async function bootstrap() {
    const app = await NestFactory.create(MainModule);
    const config = app.get(Config);
    app.setBaseViewsDir(join(__dirname, "controllers/app"));
    app.setViewEngine("hbs");
    app.use(helmet());
    app.use(compression());
    app.useGlobalFilters(new ViewAuthFailedFilter());
    await app.listen(config.port);
}
{% endhighlight %}

The first thing that's setup is the [_view engine_](https://expressjs.com/en/guide/using-template-engines.html). Any of the ones available for Express are usable, and I've chosen [Handlebars](https://handlebarsjs.com/). There isn't any particularly strong reason, and in fact any one could do. The project won't need _massive complexity_ here. I'll cover more in a bit about the "rendering philosophy". The other two things are setting up [helmet](https://helmetjs.github.io/) with default settings and enabling [compression](https://github.com/expressjs/compression). The first one is particularly important, as it provides a baseline of browser oriented security measures - DNS prefetch control, frameguard, HSTS etc. As the project progresses, I'll enable more of them as well, though for some the cost-benefit analysis doesn't look so good for such a small project like this one (public key pinning for example). The second one is self-explanatory - it enables compression.

Should have a request id one. But there's no good typescript one, so we improvise. We add the requestId to the Request, cause why not.

Should have a request time one.

Should have an application version one

Sessions middleware

Classical view rendering && big discussion on why this is still important.

When setting up the middleware I used the [express middleware list](http://expressjs.com/en/resources/middleware.html) to get a feel for the _common_ ones I shouldn't miss out. For the whole project I want to avoid reinventing the wheel as much as possible, and having these lists of middleware/best practices/common approaches is really helpful.

Secrets handling

Checkout all the articles in the series [here](https//horia141.com/retrofeed.html).
